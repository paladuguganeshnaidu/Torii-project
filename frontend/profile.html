<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Profile • Torii</title>
  <style>
    :root{--bg:#f6f7fb;--fg:#0b1324;--card:#fff;--border:#e5e7eb;--primary:#667eea;--success:#10b981;--error:#ef4444}
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:700px;margin:40px auto;padding:0 20px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06);padding:24px;margin-bottom:20px}
    .header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    .avatar{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#8b62ff);color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700}
    .user-info{flex:1}
    .user-email{font-size:18px;font-weight:600;margin-bottom:4px}
    .user-meta{font-size:13px;color:#6b7280}
    h2{margin:0 0 16px;font-size:18px}
    label{display:block;font-size:13px;font-weight:500;color:#4b5563;margin:12px 0 6px}
    input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:14px;box-sizing:border-box}
    input:focus{outline:none;border-color:var(--primary)}
    .btn{background:var(--primary);color:white;border:none;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s}
    .btn:hover{background:#5568d3;transform:translateY(-1px)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:14px}
    .alert.success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .alert.error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .back-link{color:#6b7280;text-decoration:none;font-size:14px}
    .back-link:hover{color:var(--primary)}
  </style>
  <link rel="stylesheet" href="/assets/css/cyber-bg.css">
</head>
<body>
  <canvas id="cyber-canvas"></canvas>
  <div class="wrap">
    <a href="/" class="back-link">← Back to Home</a>
    
    <div class="card">
      <div class="header">
        <div class="avatar" id="avatar">?</div>
        <div class="user-info">
          <div class="user-email" id="email">Loading...</div>
          <div class="user-meta">
            <span id="mobile"></span>
            <span id="registered"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Change Password</h2>
      <div id="message"></div>
      
      <form id="passwordForm" onsubmit="changePassword(event)">
        <label>Current Password</label>
        <input type="password" id="current_password" required autocomplete="current-password" />
        
        <label>New Password (min 6 characters)</label>
        <input type="password" id="new_password" required minlength="6" autocomplete="new-password" />
        
        <label>Confirm New Password</label>
        <input type="password" id="confirm_password" required minlength="6" autocomplete="new-password" />
        
        <div style="margin-top:20px">
          <button type="submit" class="btn" id="submitBtn">Change Password</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/assets/js/cyber-bg.js"></script>
  <script>
    async function loadProfile() {
      try {
        const res = await fetch('/api/profile');
        const data = await res.json();
        
        if (!data.ok) {
          window.location.href = '/auth/login';
          return;
        }
        
        const user = data.user;
        document.getElementById('email').textContent = user.email || '';
        document.getElementById('mobile').textContent = user.mobile ? user.mobile + ' • ' : '';
        document.getElementById('registered').textContent = user.registered_at ? 'Joined ' + new Date(user.registered_at).toLocaleDateString() : '';
        
        // Set avatar
        const firstLetter = (user.email || '?').charAt(0).toUpperCase();
        document.getElementById('avatar').textContent = firstLetter;
      } catch (error) {
        console.error('Failed to load profile:', error);
        window.location.href = '/auth/login';
      }
    }

    async function changePassword(event) {
      event.preventDefault();
      
      const current = document.getElementById('current_password').value;
      const newPass = document.getElementById('new_password').value;
      const confirm = document.getElementById('confirm_password').value;
      const messageDiv = document.getElementById('message');
      const submitBtn = document.getElementById('submitBtn');
      
      // Clear previous messages
      messageDiv.innerHTML = '';
      
      // Client-side validation
      if (newPass !== confirm) {
        messageDiv.innerHTML = '<div class="alert error">New passwords do not match</div>';
        return;
      }
      
      if (newPass.length < 6) {
        messageDiv.innerHTML = '<div class="alert error">Password must be at least 6 characters</div>';
        return;
      }
      
      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Changing...';
      
      try {
        const res = await fetch('/api/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            current_password: current,
            new_password: newPass,
            confirm_password: confirm
          })
        });
        
        const data = await res.json();
        
        if (data.ok) {
          messageDiv.innerHTML = '<div class="alert success">' + (data.message || 'Password changed successfully!') + '</div>';
          document.getElementById('passwordForm').reset();
          
          // Redirect to login after 2 seconds
          setTimeout(() => {
            window.location.href = '/auth/login';
          }, 2000);
        } else {
          messageDiv.innerHTML = '<div class="alert error">' + (data.error || 'Failed to change password') + '</div>';
        }
      } catch (error) {
        messageDiv.innerHTML = '<div class="alert error">Network error. Please try again.</div>';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Change Password';
      }
    }
    
    // Load profile on page load
    loadProfile();
  </script>
</body>
</html>
