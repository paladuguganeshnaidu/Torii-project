<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Torii ¬∑ StegoShield Inspector</title>
    <link rel="stylesheet" href="assets/css/main.css?v=2" />
    <link rel="stylesheet" href="/assets/css/cyber-bg.css">
    <link rel="stylesheet" href="/assets/css/tools.css">
</head>
<body class="home">
    <canvas id="cyber-canvas"></canvas>
    <div class="app">
        <header>
            <div class="brand"><span class="logo" aria-hidden="true"></span><span class="title">Torii</span></div>
            <nav>
                <a href="index.html">Home</a>
                <span aria-hidden="true">¬∑</span>
                <a href="/auth/login">Login</a>
                <span aria-hidden="true">¬∑</span>
                <a href="/auth/register">Register</a>
            </nav>
        </header>

        <div class="card">
            <h2>üõ°Ô∏è StegoShield Inspector</h2>
            <p class="muted">Hide secret text in images (steganography) or create prank files with fake error popups.</p>
            
            <div class="field">
                <label for="imageFile">Upload Image (PNG/JPG)</label>
                <input id="imageFile" type="file" accept="image/png,image/jpeg,image/jpg" />
            </div>

            <div class="field">
                <label for="inspectType">Inspection Type</label>
                <select id="inspectType">
                    <option value="">-- Select Type --</option>
                    <option value="txt">Text Steganography</option>
                    <option value="virus">Prank / Virus Mode</option>
                    <option value="malware">Malware Analysis</option>
                    <option value="suspicious">Suspicious Data</option>
                </select>
            </div>

            <div class="field" id="stegoModeField" style="display:none;">
                <label for="stegoMode">Steganography Mode</label>
                <select id="stegoMode">
                    <option value="encode">Hide Text (Encode)</option>
                    <option value="decode">Extract Text (Decode)</option>
                </select>
            </div>

            <div class="field" id="textInputField" style="display:none;">
                <label for="customText">Enter Secret Text to Hide</label>
                <textarea id="customText" rows="3" placeholder="Your secret message here..."></textarea>
                <small style="color:#888;">Text will be hidden in image pixels using LSB steganography (invisible to the eye)</small>
            </div>

            <div class="field" id="virusTypeField" style="display:none;">
                <label for="virusType">Select Mode</label>
                <select id="virusType">
                    <option value="prank">üé≠ Prank Mode (Fake Error Popup)</option>
                    <option value="manipulate">‚ö†Ô∏è Manipulative Warning</option>
                    <option value="real">üö® Real Virus Alert</option>
                </select>
                <small style="color:#888;" id="prankHelp">Prank: Generates HTML file that shows fake "Error Transferring Data" popup when opened</small>
            </div>

            <div class="field">
                <label for="outputFormat">Output Format</label>
                <select id="outputFormat">
                    <option value="png">PNG Image</option>
                    <option value="jpg">JPG Image</option>
                    <option value="html">HTML File (for prank)</option>
                    <option value="pdf">PDF Document</option>
                </select>
                <small style="color:#888;">HTML format recommended for prank mode; PNG/JPG for regular images</small>
            </div>

            <button class="btn primary" onclick="inspectImage()">Process Image</button>
            <div id="out" class="result" style="margin-top:12px; word-wrap:break-word; word-break:break-all; white-space:pre-wrap; overflow-x:auto; max-height:400px; overflow-y:auto;"></div>
            <div id="downloadSection" style="display:none; margin-top:12px;">
                <p><strong id="downloadTitle">Processed result ready:</strong></p>
                <a id="downloadLink" class="btn" download="output_image.png">Download File</a>
            </div>
        </div>
    </div>

    <script src="/assets/js/cyber-bg.js"></script>
    <script src="/assets/js/tools-ui.js"></script>
    <script>
        const typeSelect = document.getElementById('inspectType');
        const textField = document.getElementById('textInputField');
        const virusField = document.getElementById('virusTypeField');
        const stegoModeField = document.getElementById('stegoModeField');
        const stegoModeSelect = document.getElementById('stegoMode');
        const prankHelp = document.getElementById('prankHelp');
        const virusTypeSelect = document.getElementById('virusType');

        typeSelect.addEventListener('change', () => {
            const val = typeSelect.value;
            
            if(val === 'txt') {
                stegoModeField.style.display = 'block';
                textField.style.display = 'block';
                virusField.style.display = 'none';
                updateTextFieldVisibility();
            } else if(['virus','malware','suspicious'].includes(val)) {
                stegoModeField.style.display = 'none';
                textField.style.display = 'none';
                virusField.style.display = 'block';
            } else {
                stegoModeField.style.display = 'none';
                textField.style.display = 'none';
                virusField.style.display = 'none';
            }
        });

        stegoModeSelect.addEventListener('change', updateTextFieldVisibility);

        function updateTextFieldVisibility() {
            if(typeSelect.value === 'txt') {
                if(stegoModeSelect.value === 'decode') {
                    textField.style.display = 'none';
                } else {
                    textField.style.display = 'block';
                }
            }
        }

        virusTypeSelect.addEventListener('change', () => {
            if(virusTypeSelect.value === 'prank') {
                prankHelp.textContent = 'Prank: Generates HTML file that shows fake "Error Transferring Data" popup when opened';
            } else if(virusTypeSelect.value === 'manipulate') {
                prankHelp.textContent = 'Manipulate: Adds warning overlay to image';
            } else {
                prankHelp.textContent = 'Real: Simulates virus detection alert';
            }
        });

        async function inspectImage(){
            const fileInput = document.getElementById('imageFile');
            const inspectType = document.getElementById('inspectType').value;
            const customText = document.getElementById('customText').value;
            const virusType = document.getElementById('virusType').value;
            const stegoMode = document.getElementById('stegoMode').value;
            const outputFormat = document.getElementById('outputFormat').value;
            const outDiv = document.getElementById('out');
            const downloadSection = document.getElementById('downloadSection');
            const downloadLink = document.getElementById('downloadLink');
            const downloadTitle = document.getElementById('downloadTitle');

            if(!fileInput.files.length){
                outDiv.textContent = 'Error: Please upload an image.';
                return;
            }
            if(!inspectType){
                outDiv.textContent = 'Error: Please select an inspection type.';
                return;
            }

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('inspect_type', inspectType);
            formData.append('stego_mode', stegoMode);
            formData.append('output_format', outputFormat);
            if(customText) formData.append('custom_text', customText);
            if(virusType) formData.append('virus_type', virusType);

            outDiv.textContent = 'Processing...';
            downloadSection.style.display = 'none';

            try {
                const res = await fetch('/api/stegoshield-inspector', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if(data.ok){
                    outDiv.textContent = JSON.stringify(data, null, 2);
                    
                    if(data.prank_html){
                        // HTML format: download HTML file
                        const blob = new Blob([data.prank_html], {type: 'text/html'});
                        const url = URL.createObjectURL(blob);
                        downloadLink.href = url;
                        downloadLink.download = 'image_viewer.html';
                        downloadTitle.textContent = 'üé≠ HTML File Ready! Send this to your friend:';
                        downloadSection.style.display = 'block';
                    } else if(data.pdf_base64){
                        // PDF format
                        downloadLink.href = 'data:application/pdf;base64,' + data.pdf_base64;
                        downloadLink.download = 'processed_document.pdf';
                        downloadTitle.textContent = 'üìÑ PDF Document ready:';
                        downloadSection.style.display = 'block';
                    } else if(data.image_base64){
                        // Image format (PNG/JPG)
                        const format = data.output_format || 'png';
                        const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
                        downloadLink.href = 'data:' + mimeType + ';base64,' + data.image_base64;
                        downloadLink.download = 'processed_image.' + format;
                        downloadTitle.textContent = `${format.toUpperCase()} Image ready:`;
                        downloadSection.style.display = 'block';
                    }
                    
                    if(data.hidden_text){
                        outDiv.textContent += '\n\nüìù Hidden Text Extracted:\n' + data.hidden_text;
                    }
                } else {
                    outDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
                }
            } catch(err){
                outDiv.textContent = 'Network error: ' + err.message;
            }
        }
    </script>
</body>
</html>
