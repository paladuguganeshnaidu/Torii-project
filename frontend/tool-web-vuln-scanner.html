<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Vulnerability Scanner — Torii</title>
  <link rel="stylesheet" href="assets/css/main.css?v=2" />
  <meta name="description" content="Run a lightweight, safe web vulnerability surface scan (passive checks) in the background." />
  <style>
    .tool-page{max-width:980px;margin:28px auto;padding:18px}
    .tool-header{display:flex;align-items:center;gap:12px}
    .tool-card{background:#fff;border:1px solid #e6e9ef;border-radius:12px;padding:18px;margin-top:18px}
    .btn{background:#2563eb;color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
    .btn.secondary{background:#eef2ff;color:#2563eb}
    .input{width:100%;padding:10px;border-radius:8px;border:1px solid #dbe2f0}
    .muted{color:#64748b;font-size:14px}
    pre.results{background:#0b1220;color:#dbeafe;padding:12px;border-radius:8px;overflow:auto}
    .kpi{display:flex;gap:12px;margin-top:12px}
    .kpi .item{background:#f8fafc;border:1px solid #e6eef8;padding:10px;border-radius:8px}
  </style>
</head>
<body class="tool-page">
  <div class="tool-page">
    <a href="/" class="plain">← Home</a>
    <header class="tool-header">
      <h1>Web Vulnerability Scanner</h1>
    </header>

    <p class="muted">This tool performs a small set of non-invasive checks (headers, robots, basic fingerprinting, and common endpoint probe). Long, aggressive scans are not supported here — use a dedicated scanner on your own infrastructure.</p>

    <div class="tool-card">
      <label for="targetUrl">Target URL</label>
      <input id="targetUrl" class="input" placeholder="https://example.com" />
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="startBtn" class="btn">Start scan</button>
        <button id="cancelBtn" class="btn secondary">Cancel</button>
      </div>

      <div class="kpi">
        <div class="item">Status: <strong id="scanStatus">idle</strong></div>
        <div class="item">Scan ID: <strong id="scanId">-</strong></div>
        <div class="item">Elapsed: <strong id="elapsed">0s</strong></div>
      </div>

      <div style="margin-top:14px">
        <h3>Results</h3>
        <pre id="results" class="results">No results yet.</pre>
      </div>
    </div>
  </div>

  <script>
    let pollHandle = null;
    let startedAt = null;

    function setStatus(s){ document.getElementById('scanStatus').textContent = s }
    function setScanId(id){ document.getElementById('scanId').textContent = id }
    function setElapsed(){ if(!startedAt) return; const s = Math.floor((Date.now()-startedAt)/1000); document.getElementById('elapsed').textContent = s+"s" }
    function setResults(txt){ document.getElementById('results').textContent = typeof txt === 'string' ? txt : JSON.stringify(txt, null, 2) }

    async function startScan(){
      const url = document.getElementById('targetUrl').value.trim();
      if(!url) { alert('Please enter a URL'); return }
      try{
        setStatus('starting');
        const res = await fetch('/api/scan', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({url}) });
        const data = await res.json();
        if(!res.ok){ setStatus('error'); setResults(data.error || JSON.stringify(data)); return }
        const scan_id = data.scan_id;
        setScanId(scan_id);
        setStatus('running');
        startedAt = Date.now();
        setResults('Scan started — polling for results...');
        pollHandle = setInterval(async ()=>{
          setElapsed();
          try{
            const s = await fetch('/api/scan/'+encodeURIComponent(scan_id));
            const info = await s.json();
            if(info.status === 'running'){
              // still working
              return;
            }
            clearInterval(pollHandle); pollHandle = null;
            if(info.status === 'complete'){
              setStatus('complete');
              setResults(info.results || 'No findings');
            } else if(info.status === 'error'){
              setStatus('error');
              setResults(info.error || 'Unknown error');
            } else {
              setStatus(info.status || 'unknown'); setResults(info);
            }
          }catch(e){ clearInterval(pollHandle); pollHandle=null; setStatus('error'); setResults(String(e)); }
        }, 2000);
      }catch(e){ setStatus('error'); setResults(String(e)) }
    }

    document.getElementById('startBtn').addEventListener('click', startScan);
    document.getElementById('cancelBtn').addEventListener('click', ()=>{
      if(pollHandle){ clearInterval(pollHandle); pollHandle=null; setStatus('cancelled'); }
    });
  </script>
</body>
</html>
